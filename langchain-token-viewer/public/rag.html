<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RAG PDF Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="app" class="container py-5">
      <h2 class="mb-4 text-center">ðŸ“„ Chat with your PDFs</h2>

      <div class="mb-3">
        <input
          v-model="question"
          @keyup.enter="ask"
          placeholder="Ask a question..."
          class="form-control form-control-lg"
        />
      </div>
      <div class="d-grid mb-4">
        <button class="btn btn-primary btn-lg" @click="ask" :disabled="loading">
          {{ loading ? 'Thinking...' : 'Ask' }}
        </button>
      </div>

      <div v-if="answer" class="card mb-4">
        <div class="card-header fw-bold">Answer</div>
        <div class="card-body" v-html="parsedAnswer"></div>
      </div>

      <div v-if="citations?.length" class="card mb-4">
        <div class="card-header fw-bold">Citations</div>
        <ul class="list-group list-group-flush">
          <li v-for="c in citations" :key="c.index" class="list-group-item">
            <a
              :href="buildViewerUrl(c.anchor, c.snippet)"
              class="link-primary"
              target="_blank"
            >
              [{{ c.index }}] {{ c.source }} â€” {{ c.snippet }}
            </a>
          </li>
        </ul>
      </div>
    </div>

    <script>
      const { createApp, ref, computed } = Vue;

      createApp({
        setup() {
          const question = ref("");
          const answer = ref("");
          const citations = ref([]);
          const loading = ref(false);

          const parsedAnswer = computed(() => marked.parse(answer.value || ""));

          const ask = async () => {
            if (!question.value.trim()) return;

            loading.value = true;
            answer.value = "";
            citations.value = [];

            try {
              const res = await fetch("http://localhost:3000/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: question.value }),
              });

              const data = await res.json();
              answer.value = data.answer;
              citations.value = data.citations;
            } catch (e) {
              answer.value = "âŒ Something went wrong.";
            } finally {
              loading.value = false;
            }
          };

          const buildViewerUrl = (anchor, keyword = "") => {
            const [file, hash] = anchor.split("#"); // e.g., doc.pdf#page=2
            return `/pdf-viewer.html?file=${encodeURIComponent(
              file
            )}&${hash}&q=${encodeURIComponent(keyword)}`;
          };

          return {
            question,
            answer,
            citations,
            loading,
            parsedAnswer,
            ask,
            buildViewerUrl,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
